<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Biobags Insights Dashboard</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <style>
        :root {
            --bg: #0a0f1f;
            --panel: #0f162c;
            --panel-2: #0c1427;
            --ring: #23314e;
            --ring-2: #2e4167;
            --fg: #e8efff;
            --muted: #93a7cc;
            --accent: #00e099;
            --accent-2: #5cb3ff;
            --warn: #ffd166;
            --danger: #ff4757;
            --grid: 16px;
            --radius: 14px;
            --shadow: 0 10px 28px rgba(0, 0, 0, .35);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background:
                radial-gradient(1000px 400px at 15% -10%, #0f1c3a 0%, transparent 60%),
                radial-gradient(900px 500px at 110% 10%, #0a1a34 0%, transparent 60%),
                var(--bg);
            color: var(--fg);
            font: 14px/1.5 system-ui, Segoe UI, Roboto, Helvetica, Arial;
        }

        .wrap {
            max-width: 1440px;
            margin: 28px auto;
            padding: 0 16px;
            padding-bottom: 60px !important;
        }

        h1 {
            margin: 0 0 18px;
            text-align: center;
            font-size: 28px;
            letter-spacing: .3px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent
        }

        /* Panels & grids */
        .grid {
            display: grid;
            gap: var(--grid);
            min-width: 0
        }

        .controls {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            align-items: end;
            top: 14px;
            z-index: 5;
            padding: 12px;
            background: linear-gradient(180deg, rgba(15, 22, 44, .95), rgba(15, 22, 44, .75));
            border: 1px solid var(--ring);
            backdrop-filter: blur(8px);
            border-radius: var(--radius)
        }

        .cards {
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr))
        }

        .panel {
            background: linear-gradient(180deg, rgba(15, 22, 44, .95), rgba(15, 22, 44, .88));
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: var(--radius);
            box-shadow: var(--shadow)
        }

        .panel.pad {
            padding: 14px
        }

        .panel:hover {
            border-color: rgba(255, 255, 255, .1)
        }

        .title {
            font-weight: 700;
            margin: 0 0 10px;
            letter-spacing: .2px
        }

        .muted {
            color: var(--muted)
        }

        /* Inputs */
        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin: 0 0 6px
        }

        select,
        input {
            width: 100%;
            padding: 9px 10px;
            border: 1px solid #314061;
            background: #0b1326;
            color: var(--fg);
            border-radius: 10px
        }

        select:focus,
        input:focus {
            outline: 0;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 224, 153, .18)
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            border: 0;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff
        }

        .btn.secondary {
            background: linear-gradient(135deg, #0ea5e9, #0284c7)
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid var(--ring)
        }

        .btn.logout {
            background: #ff5353;
            border: 1px solid var(--ring)
        }

        /* Active tab button */
        .btn.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
            border: none;
        }


        /* KPIs */
        .kpi .v {
            font-size: 20px;
            font-weight: 800;
            margin: 6px 0
        }

        .kpi .subl {
            font-size: 12px;
            color: var(--muted)
        }

        .kpi {
            position: relative;
            overflow: hidden
        }

        .kpi:after {
            content: "";
            position: absolute;
            inset: auto -20% -45% -20%;
            height: 70px;
            background: radial-gradient(140px 60px at 50% 0, rgba(0, 224, 153, .18), transparent 70%);
            filter: blur(8px)
        }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse
        }

        .table thead th {
            position: sticky;
            top: 0;
            background: rgba(12, 20, 38, .98);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid #2b3b62;
            padding: 10px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .4px;
            text-align: right
        }

        .table thead th:first-child,
        .table tbody td:first-child {
            text-align: left
        }

        .table tbody td {
            padding: 10px;
            border-bottom: 1px solid #1d2a49;
            text-align: right
        }

        .table tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, .02)
        }

        .chip {
            display: inline-block;
            padding: .22rem .55rem;
            border: 1px solid var(--ring);
            border-radius: 999px;
            font-size: 12px
        }

        .ok {
            color: var(--accent)
        }

        .warn {
            color: var(--warn)
        }

        .bad {
            color: var(--danger)
        }

        /* Charts */
        .chart-wrap {
            height: clamp(240px, 30vw, 320px);
            display: flex;
            align-items: center;
            justify-content: center
        }

        .chart-wrap.tall {
            height: clamp(320px, 40vw, 480px)
        }

        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            background: #0b1326;
            border-radius: 10px
        }

        .notice {
            padding: 12px;
            border: 1px solid var(--ring);
            border-radius: 12px;
            background: rgba(255, 255, 255, .04)
        }

        .loading {
            text-align: center;
            color: var(--muted);
            padding: 12px
        }

        .error {
            display: none;
            padding: 12px;
            border-radius: 12px;
            background: rgba(255, 71, 87, .12);
            border: 1px solid rgba(255, 71, 87, .45);
            color: #fff
        }

        @media (max-width:920px) {
            .controls {
                grid-template-columns: 1fr 1fr
            }

            .cards {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        @media (max-width:600px) {
            .controls {
                grid-template-columns: 1fr
            }

            .cards {
                grid-template-columns: 1fr
            }
        }

        #tabDashboard,
        #tabReports {
            min-width: 120px
        }

        #reports .title,
        #dashboard .title {
            letter-spacing: .2px
        }

        /* Horizontal scroll area for wide tables */
        .hscroll {
            overflow-x: auto;
        }

        /* Keep all content in one line for dense order tables */
        .nowrap th,
        .nowrap td {
            white-space: nowrap;
        }

        /* Simple pager */
        .pager {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
            padding: 10px 14px;
            border-top: 1px solid var(--ring);
        }

        .pager button {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--ring);
            background: #0b1326;
            color: var(--fg);
            cursor: pointer;
        }

        .pager .info {
            color: var(--muted);
            font-size: 12px;
        }

        /* --- Mobile overflow fixes & table-only horizontal scroll --- */
        html,
        body {
            max-width: 100vw;
            overflow-x: hidden;
            /* prevent page-level horizontal scroll */
            min-height: 100vh;
        }

        .hscroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
        }

        /* Let wide tables scroll inside their wrapper instead of growing the page */
        .hscroll>.table {
            width: max-content;
            /* expand to content width */
            min-width: 100%;
            /* but at least fill container */
        }

        /* Panels should not leak content outside on small screens */
        .panel {
            overflow: hidden;
        }

        /* Many inline grids in the markup use minmax(320/340/360px,1fr).
   Force single-column on phones to avoid overflow from those inline styles */
        @media (max-width: 600px) {

            #reports .grid,
            #dashboard .grid {
                grid-template-columns: 1fr !important;
            }

            /* Optional: make sticky headers more compact on phones */
            .table thead th {
                font-size: 11px;
                padding: 8px;
            }

            .table tbody td {
                font-size: 13px;
                padding: 8px;
            }

            .title-buttons {
                flex-direction: row !important;
            }
        }

        /* Friendlier month picker styling */
        .month-picker {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .month-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--ring);
            background: #0b1326;
            color: var(--fg);
            border-radius: 10px;
            cursor: pointer;
        }

        .month-label {
            flex: 1 1 auto;
            padding: 9px 10px;
            border: 1px solid #314061;
            background: #0b1326;
            color: var(--fg);
            border-radius: 10px;
            text-align: center;
            white-space: nowrap;
        }

        /* Let the Period control span two columns on desktop for more room */
        .controls .span-2 {
            grid-column: span 2;
        }

        .title-buttons {
            flex-direction: row !important;
        }

        @media (max-width: 920px) {
            .controls .span-2 {
                grid-column: span 1;
            }
        }

        /* Layout for the Period row: big select + navigator */
        .period-wrap {
            display: grid;
            grid-template-columns: minmax(180px, 260px) 1fr;
            /* roomy select */
            gap: 8px;
        }

        @media (max-width: 600px) {
            .period-wrap {
                grid-template-columns: 1fr;
            }

            /* stack on small screens */
        }

        /* Make the navigator label flexible and readable */
        .month-picker {
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
        }

        .month-label {
            flex: 1 1 auto;
            min-width: 160px;
            padding: 9px 10px;
            border: 1px solid var(--ring);
            border-radius: 10px;
            background: #0b1326;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .month-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--ring);
            background: #0b1326;
            border-radius: 10px;
        }

        /* --- Auth screen --- */
        .auth-wrap {
            min-height: 100dvh;
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .auth-card {
            width: 100%;
            max-width: 380px;
            padding: 20px;
            background: linear-gradient(180deg, rgba(15, 22, 44, .95), rgba(15, 22, 44, .88));
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .auth-card h2 {
            margin: 0 0 12px;
            font-size: 19px;
            letter-spacing: .2px;
        }

        .auth-row {
            margin: 10px 0;
        }

        .auth-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .auth-error {
            display: none;
            margin-top: 8px;
            font-size: 13px;
            color: #fff;
            background: rgba(255, 71, 87, .12);
            border: 1px solid rgba(255, 71, 87, .45);
            padding: 8px 10px;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <!-- Auth Gate -->
    <div id="authScreen" class="auth-wrap">
        <div class="auth-card">
            <h2>üîê Sign in to B2B Traders | Biobags</h2>
            <div class="auth-row">
                <label>Username</label>
                <input id="authUser" type="text" placeholder="Username" />
            </div>
            <div class="auth-row">
                <label>Password</label>
                <input id="authPass" type="password" placeholder="Password" />
            </div>
            <div class="auth-actions">
                <button class="btn" id="authLogin">Login</button>
                <button class="btn ghost" id="authClear">Clear</button>
            </div>
            <div id="authError" class="auth-error">Invalid credentials. Try again.</div>
        </div>
    </div>

    <!-- Hide the app until authenticated -->
    <div class="wrap" id="appRoot" style="display:none">

        <!-- Tabs -->
        <div class="title-buttons" style="grid-template-columns: 1fr auto; align-items:center; margin-bottom:12px">
            <h1>Biobags Insight Dashboard</h1>
            <div style="display:flex; gap:8px">
                <button class="btn ghost" id="tabDashboard">Dashboard</button>
                <button class="btn ghost" id="tabReports">Reports</button>
                <button class="btn ghost logout" id="btnLogout" title="Logout">Logout</button>
            </div>
        </div>
        <div id="dashboard">
            <!-- ‚úÖ MOVE your existing Dashboard HTML here (everything you already have today) -->

            <!-- Controls -->
            <div class="grid controls panel pad">
                <div>
                    <label>üìÖ Period</label>
                    <select id="period">
                        <option>Monthly</option>
                        <option>Quarterly</option>
                        <option>Half-Yearly</option>
                        <option>Yearly</option>
                    </select>
                </div>
                <div>
                    <label>üìÖ Start Date</label>
                    <input type="date" id="startDate" />
                </div>
                <div>
                    <label>üìÖ End Date</label>
                    <input type="date" id="endDate" />
                </div>
                <div>
                    <label>üìã Status</label>
                    <select id="status">
                        <option>All</option>
                        <option>Open</option>
                        <option>Closed</option>
                    </select>
                </div>
                <div>
                    <label>üöö Delivered</label>
                    <select id="delivered">
                        <option>All</option>
                        <option>Yes</option>
                        <option>No</option>
                    </select>
                </div>
                <div>
                    <label>üë§ Focus Client</label>
                    <select id="focusClient">
                        <option value="">All</option>
                    </select>
                    <input type="hidden" id="search" placeholder="Type to filter" />
                </div>
                <div>
                    <label>üîß Actions</label>
                    <div class="row">
                        <button class="btn" id="reload">Refresh</button>
                        <button class="btn secondary" id="download">Download</button>
                    </div>
                </div>
                <div>
                    <label>‚ôªÔ∏è Filters</label>
                    <button class="btn ghost" id="reset">Reset</button>
                </div>
            </div>

            <div id="loading" class="loading" style="display:none">Loading data‚Ä¶</div>
            <div id="error" class="error"></div>

            <!-- KPI cards -->
            <div class="grid cards" style="margin-top:16px">
                <div class="panel pad kpi">
                    <div class="title">üì¶ Orders</div>
                    <div class="v" id="k_orders">-</div>
                    <div class="subl">Count</div>
                </div>
                <div class="panel pad kpi">
                    <div class="title">‚öñÔ∏è Quantity</div>
                    <div class="v" id="k_qty">-</div>
                    <div class="subl">Kg</div>
                </div>
                <div class="panel pad kpi">
                    <div class="title">üí∞ Revenue</div>
                    <div class="v" id="k_rev">-</div>
                    <div class="subl">‚Çπ</div>
                </div>
                <div class="panel pad kpi">
                    <div class="title">üí∏ Cost</div>
                    <div class="v" id="k_cost">-</div>
                    <div class="subl">‚Çπ</div>
                </div>
                <div class="panel pad kpi">
                    <div class="title">üìà Profit</div>
                    <div class="v" id="k_profit">-</div>
                    <div class="subl">‚Çπ Total</div>
                </div>
                <div class="panel pad kpi">
                    <div class="title">üìä Avg Price</div>
                    <div class="v" id="k_avgsp">-</div>
                    <div class="subl">‚Çπ/Kg (Sell | Cost | Margin%)</div>
                </div>
                <div class="panel pad kpi">
                    <div class="title">‚è≥ Credit</div>
                    <div class="v" id="k_pending">-</div>
                    <div class="subl">‚Çπ Receivables</div>
                </div>
                <div class="panel pad kpi">
                    <div class="title">üßæ Open vs Closed</div>
                    <div class="v"><span id="k_open">-</span> / <span id="k_closed">-</span></div>
                    <div class="subl">Open / Closed</div>
                </div>
                <!-- NEW: Need to Pay split by Paid (Yes | Not Yet) -->
                <div class="panel pad kpi">
                    <div class="title">üßæ Need to Pay</div>
                    <div class="v" id="k_needpay_split">-</div>
                    <div class="subl">Paid | Not Paid</div>
                </div>

                <!-- NEW: Profit split (Kavin | Vicky) -->
                <div class="panel pad kpi">
                    <div class="title">ü§ù Profit Split</div>
                    <div class="v" id="k_profit_split">-</div>
                    <div class="subl">Kavin | Vicky</div>
                </div>
                <div class="panel pad kpi">
                    <div class="title">üíπ Investments</div>
                    <div class="v" id="k_investments">-</div>
                    <div class="subl">Kavin | Vicky</div>
                </div>
                <!-- NEW: Stereo Cost (sum under current dashboard filters) -->
                <div class="panel pad kpi">
                    <div class="title">üéõÔ∏è Stereo Cost</div>
                    <div class="v" id="k_stereo">-</div>
                    <div class="subl">Sum in ‚Çπ</div>
                </div>

            </div>

            <!-- Time summary table -->
            <div class="panel" style="margin-top:16px">
                <div class="pad">
                    <div class="title">üìä Period Summary</div>
                </div>
                <div style="overflow:auto;border-top:1px solid var(--ring)">
                    <table class="table" id="t_period">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Revenue/Profit trends -->
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(340px,1fr));margin-top:16px">
                <div class="panel pad">
                    <div class="title">üìâ Revenue & Cost Over Time</div>
                    <div class="chart-wrap"><canvas id="c_rev_cost"></canvas></div>
                </div>
                <div class="panel pad">
                    <div class="title">üìà Profit Over Time</div>
                    <div class="chart-wrap"><canvas id="c_profit"></canvas></div>
                </div>
            </div>

            <!-- Core distributions -->
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(340px,1fr));margin-top:16px">
                <div class="panel pad">
                    <div class="title">üè≠ Manufacturer-wise Quantity (kg)</div>
                    <div class="chart-wrap"><canvas id="c_by_manu"></canvas></div>
                </div>
                <div class="panel pad">
                    <div class="title">üé® Type-wise Quantity (kg)</div>
                    <div class="chart-wrap"><canvas id="c_by_type"></canvas></div>
                </div>
            </div>
            <div class="panel pad" style="margin-top:16px">
                <div class="title">üìè Size-wise Quantity (kg)</div>
                <div class="chart-wrap tall"><canvas id="c_by_size"></canvas></div>
            </div>

            <!-- Status & Delivery -->
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(340px,1fr));margin-top:16px">
                <div class="panel pad">
                    <div class="title">üìã Status Distribution</div>
                    <div class="chart-wrap"><canvas id="c_status"></canvas></div>
                </div>
                <div class="panel pad">
                    <div class="title">üöö Delivery Status</div>
                    <div class="chart-wrap"><canvas id="c_delivery"></canvas></div>
                </div>
            </div>

            <!-- Client Intelligence -->
            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(360px,1fr));margin-top:16px">
                <div class="panel pad">
                    <div class="title">üëë Top Clients by Quantity (kg)</div>
                    <div class="chart-wrap"><canvas id="c_client_top"></canvas></div>
                </div>
                <div class="panel pad">
                    <div class="title">üß≠ Focus Client ‚Üí Size (kg)</div>
                    <div class="chart-wrap"><canvas id="c_client_size"></canvas></div>
                </div>
                <div class="panel pad">
                    <div class="title">üé® Focus Client ‚Üí Type (kg)</div>
                    <div class="chart-wrap"><canvas id="c_client_type"></canvas></div>
                </div>
                <div class="panel pad">
                    <div class="title">üè≠ Size ‚Üí Manufacturer Mix (Top Sizes)</div>
                    <div class="chart-wrap"><canvas id="c_size_manu"></canvas></div>
                </div>
            </div>

            <!-- Client Insights (improved logic) -->
            <div class="panel" style="margin-top:16px">
                <div class="pad">
                    <div class="title">üßë‚Äçü§ù‚Äçüßë Client Insights (behavior, pricing, preferences & risk)</div>
                </div>
                <div style="overflow:auto;border-top:1px solid var(--ring)">
                    <table class="table" id="t_clients">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Total Qty</th>
                                <th>Revenue</th>
                                <th>Profit</th>
                                <th>Avg ‚Çπ/kg</th>
                                <th>Top Size</th>
                                <th>Top Type</th>
                                <th>Realized ‚Çπ/kg (Top)</th>
                                <th>Configured ‚Çπ/kg (Top)</th>
                                <th>Pref. Manufacturers</th>
                                <th>Top Actual Manufacturer</th>
                                <th>Pref. Adherence</th>
                                <th>Last Order</th>
                                <th>Churn Risk</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Size‚ÄìType to Manufacturer Mapping (logical) -->
            <div class="panel" style="margin-top:16px">
                <div class="pad">
                    <div class="title">üîó Size‚ÄìType ‚Üí Manufacturer (Top by history, costs & preferences)</div>
                    <div class="notice muted">For each Size‚ÄìType: shows historical top manufacturer by qty, union of
                        client
                        preferences, recommended manufacturer (lowest cost among preferred if present, else global
                        lowest
                        cost), and the cost used.</div>
                </div>
                <div style="overflow:auto;border-top:1px solid var(--ring)">
                    <table class="table" id="t_mapping">
                        <thead>
                            <tr>
                                <th>Size</th>
                                <th>Type</th>
                                <th>Top Manufacturer (history)</th>
                                <th>Preferred Manufacturers</th>
                                <th>Recommended Manufacturer</th>
                                <th>Cost Used</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ===================== REPORTS SECTION ===================== -->
        <div id="reports" style="display:none">
            <!-- Reports: Controls -->
            <div class="grid controls panel pad" style="margin-top:8px">
                <div>
                    <label>üë§ Client</label>
                    <select id="r_client">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label>üè≠ Manufacturer</label>
                    <select id="r_manu">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="span-2">
                    <label>üóì Period</label>
                    <div class="period-wrap">
                        <select id="r_period_type">
                            <option value="month" selected>Month</option>
                            <option value="quarter">Quarter</option>
                            <option value="half">Half-Year</option>
                            <option value="year">Year</option>
                            <option value="all">All time</option>
                        </select>

                        <div class="month-picker">
                            <button type="button" class="month-btn" id="mp_prev">‚Äπ</button>
                            <div class="month-label" id="mp_label">‚Äî</div>
                            <button type="button" class="month-btn" id="mp_next">‚Ä∫</button>
                            <input type="hidden" id="r_period_value" />
                        </div>
                    </div>

                    <!-- keep your hidden search input as-is -->
                    <input type="hidden" id="r_search" placeholder="Search in orders (client/size/type/manufacturer)" />
                </div>


                <div>
                    <label>üîß Actions</label>
                    <div class="row">
                        <button class="btn" id="r_refresh">Apply</button>
                        <button class="btn secondary" id="r_download">Export CSV</button>
                    </div>
                </div>
                <div>
                    <label>‚ôªÔ∏è Filters</label>
                    <button class="btn ghost" id="r_reset">Reset</button>
                </div>
            </div>

            <!-- Client Deep Dive -->
            <div class="panel" style="margin-top:16px">
                <div class="pad">
                    <div class="title">üßë‚Äçüíº Client Deep Dive</div>
                    <div class="muted">Shows summary, mixes, and all orders for the selected client (or All).</div>
                </div>
                <div style="border-top:1px solid var(--ring)">
                    <!-- Row 1: Summary only -->
                    <div class="grid" style="grid-template-columns:1fr; padding:14px; gap:14px">
                        <div class="panel pad">
                            <div class="title">Summary</div>
                            <div class="hscroll">
                                <table class="table nowrap" id="t_client_summary">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="p_t_client_summary" class="pager"></div>
                        </div>
                    </div>

                    <!-- Row 2: Size & Type -->
                    <div class="grid"
                        style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); padding:14px; gap:14px">
                        <div class="panel pad">
                            <div class="title">Size Mix (kg)</div>
                            <div class="hscroll">
                                <table class="table nowrap" id="t_client_size">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="p_t_client_size" class="pager"></div>
                        </div>
                        <div class="panel pad">
                            <div class="title">Type Mix (kg)</div>
                            <div class="hscroll">
                                <table class="table nowrap" id="t_client_type">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="p_t_client_type" class="pager"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manufacturer Deep Dive -->
            <div class="panel" style="margin-top:16px">
                <div class="pad">
                    <div class="title">üè≠ Manufacturer Deep Dive</div>
                    <div class="muted">Shows summary, mixes, top clients, and all orders for the selected
                        manufacturer
                        (or All).</div>
                </div>
                <div style="border-top:1px solid var(--ring)">
                    <!-- Row 1: Summary only -->
                    <div class="grid" style="grid-template-columns:1fr; padding:14px; gap:14px">
                        <div class="panel pad">
                            <div class="title">Summary</div>
                            <div class="hscroll">
                                <table class="table nowrap" id="t_manu_summary">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="p_t_manu_summary" class="pager"></div>
                        </div>
                    </div>

                    <!-- Row 2: Clients, Size, Type -->
                    <div class="grid"
                        style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); padding:14px; gap:14px">
                        <div class="panel pad">
                            <div class="title">Clients (by Qty)</div>
                            <div class="hscroll">
                                <table class="table nowrap" id="t_manu_clients">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="p_t_manu_clients" class="pager"></div>
                        </div>
                        <div class="panel pad">
                            <div class="title">Size Mix (kg)</div>
                            <div class="hscroll">
                                <table class="table nowrap" id="t_manu_size">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="p_t_manu_size" class="pager"></div>
                        </div>
                        <div class="panel pad">
                            <div class="title">Type Mix (kg)</div>
                            <div class="hscroll">
                                <table class="table nowrap" id="t_manu_type">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div id="p_t_manu_type" class="pager"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shared Orders (Filtered by report controls) -->
            <div class="panel" style="margin-top:16px">
                <div class="pad">
                    <div class="title">üìú All Orders (Filtered)</div>
                    <div class="muted">This table reflects current Client/Manufacturer/Month/Search filters.</div>
                </div>
                <div class="hscroll" style="border-top:1px solid var(--ring)">
                    <table class="table nowrap" id="t_orders_shared">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="p_t_orders_shared" class="pager"></div>
            </div>

        </div>
        <!-- ===================== /REPORTS SECTION ===================== -->

    </div>

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // ====== Config ======
        const SHEET_ID = '1PvY4f3pPiSG9DrQjIO6kMQVPxB8NK0ZnMxwKOnQZi-0';
        const GID_ORDERS = '1523346431';
        const GID_CLIENTS = '1503466344';
        const GID_MANU = '159599109';
        const GID_INVEST = '489952150';
        const GID_STEREO = '1224383230';
        const URL = gid => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;

        // Orders headers (normalize once to be robust)
        const H = { orderID: 'Order ID', date: 'Date', client: 'Client', size: 'Size', type: 'Type', qty: 'Qty (kg)', manufacturer: 'Manufacturer', delivered: 'Delivered', deliveryDate: 'Delivery Date', costPrice: 'Cost Price (‚Çπ)', sellPrice: 'Sell Price (‚Çπ)', profit: 'Profit (‚Çπ)', needToPay: 'Need to Pay (‚Çπ)', paid: 'Paid', received: 'Received', got: 'Got (‚Çπ)', pending: 'Pending (‚Çπ)', paymentMode: 'Mode of Payment', status: 'Status', notes: 'Notes/Remarks' };
        const HC = { client: 'Client', size: 'Size', type: 'Type', sellRate: 'Selling Price (‚Çπ/kg)', pref: 'Preferred Manufacturer (s)' };
        const HM = { manu: 'Manufacturer', size: 'Size', type: 'Type', cost: 'Cost Price (‚Çπ/kg)' };

        // ====== State ======
        let ORDERS = [];
        let CLIENTS = [];
        let MANU = [];
        let INVEST = [];
        let STEREO = [];
        const charts = {};

        // ====== Utils ======
        const INR = new Intl.NumberFormat('en-IN');
        const toNum = x => { if (x === null || x === undefined) return 0; const n = parseFloat(String(x).replace(/[,‚Çπ\s]/g, '').trim()); return isFinite(n) ? n : 0 };
        const parseDate = d => {
            if (!d) return null; const t = new Date(d); if (!isNaN(+t)) return t; // handle dd-MMM-yyyy
            // try dd-MMM-yyyy style (e.g., 16-Sep-2025)
            const m = /^([0-9]{1,2})-([A-Za-z]{3})-([0-9]{4})$/.exec(String(d).trim());
            if (m) { const month = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].indexOf(m[2]); if (month >= 0) { return new Date(+m[3], month, +m[1]) } }
            return null
        };
        const fmtMoney = n => '‚Çπ' + INR.format(Math.round(n));
        const fmtQty = n => INR.format(Math.round(n * 100) / 100);
        const ym = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        const qtr = d => `${d.getFullYear()} Q${Math.floor(d.getMonth() / 3) + 1}`;
        const half = d => `${d.getFullYear()} H${d.getMonth() < 6 ? 1 : 2}`;
        const yr = d => String(d.getFullYear());
        const keyST = (size, type) => `${(size || '').trim()}|||${(type || '').trim()}`;

        const show = (id, display) => document.getElementById(id).style.display = display ? 'block' : 'none';
        const setError = msg => { const e = document.getElementById('error'); if (msg) { e.textContent = msg; e.style.display = 'block' } else e.style.display = 'none' };

        // CSV fetch
        async function fetchCSV(gid) { const res = await fetch(URL(gid), { cache: 'no-store' }); if (!res.ok) throw new Error(`${gid}: ${res.status} ${res.statusText}`); return res.text(); }

        async function loadAll() {
            show('loading', true); setError(null);
            const [o, c, m, i, s] = await Promise.all([fetchCSV(GID_ORDERS), fetchCSV(GID_CLIENTS), fetchCSV(GID_MANU), fetchCSV(GID_INVEST), fetchCSV(GID_STEREO)]);
            const pO = Papa.parse(o, { header: true });
            ORDERS = pO.data.filter(r => r[H.date]).map(r => {
                const d = parseDate(r[H.date]); const qty = toNum(r[H.qty]); const sp = toNum(r[H.sellPrice]); const cp = toNum(r[H.costPrice]);
                const deliveredStr = (r[H.delivered] || '').toString().trim().toLowerCase();
                const isDelivered = deliveredStr.startsWith('y');
                const status = (r[H.status] || '').toString().trim();
                return {
                    orderID: r[H.orderID] || '', date: d, client: r[H.client] || '', size: r[H.size] || '', type: r[H.type] || '', qty,
                    manufacturer: r[H.manufacturer] || '', delivered: isDelivered, deliveryDate: parseDate(r[H.deliveryDate]),
                    costPrice: cp, sellPrice: sp, revenue: qty * sp, cost: qty * cp, profit: toNum(r[H.profit]) || (qty * (sp - cp)),
                    needToPay: toNum(r[H.needToPay]), paid: (r[H.paid] || '').trim(), received: (r[H.received] || '').trim(),
                    got: toNum(r[H.got]), pending: toNum(r[H.pending]), paymentMode: (r[H.paymentMode] || '').trim(),
                    status, notes: (r[H.notes] || '').trim()
                }
            }).filter(r => r.date);

            const pC = Papa.parse(c, { header: true });
            CLIENTS = pC.data.filter(r => (r[HC.client] || '').trim()).map(r => ({
                client: (r[HC.client] || '').trim(), size: (r[HC.size] || '').trim(), type: (r[HC.type] || '').trim(),
                sellRate: toNum(r[HC.sellRate]), pref: (r[HC.pref] || '').replace(/\s+/g, ' ').trim()
            }));

            const pM = Papa.parse(m, { header: true });
            MANU = pM.data.filter(r => (r[HM.manu] || '').trim()).map(r => ({
                manu: (r[HM.manu] || '').trim(), size: (r[HM.size] || '').trim(), type: (r[HM.type] || '').trim(), cost: toNum(r[HM.cost])
            }));

            const pI = Papa.parse(i, { header: true });
            INVEST = pI.data
                .filter(r => (r['Name'] || '').trim())
                .map(r => ({
                    date: parseDate(r['Date']),
                    name: (r['Name'] || '').trim(),
                    amount: toNum(r['Amount'])
                }));

            const pS = Papa.parse(s, { header: true });
            STEREO = pS.data
                .filter(r => r['Client'] || r['Date'] || r['Cost']) // keep valid-ish rows
                .map(r => ({
                    date: parseDate(r['Date']),
                    client: (r['Client'] || '').trim(),
                    manufacturer: (r['Manufacturer'] || '').trim(),
                    type: (r['Type'] || '').trim(),
                    size: (r['Size'] || '').trim(),
                    cost: toNum(r['Cost'])
                }))
                .filter(r => r.date && r.client);

            // Focus client dropdown
            const sel = document.getElementById('focusClient');
            const clients = [...new Set(ORDERS.map(r => r.client).filter(Boolean))].sort((a, b) => a.localeCompare(b));
            sel.innerHTML = '<option value="">All</option>' + clients.map(c => `<option>${c}</option>`).join('');

            const rClient = document.getElementById('r_client');
            const rManu = document.getElementById('r_manu');
            rClient.innerHTML = '<option value="">All</option>' + clients.map(c => `<option>${c}</option>`).join('');
            const manus = [...new Set(ORDERS.map(r => r.manufacturer).filter(Boolean))].sort((a, b) => a.localeCompare(b));
            rManu.innerHTML = '<option value="">All</option>' + manus.map(c => `<option>${c}</option>`).join('');

            show('loading', false);
        }

        // ====== Filters ======
        function applyFilters(rows) {
            const s = document.getElementById('status').value;
            const d = document.getElementById('delivered').value;
            const fc = document.getElementById('focusClient').value;
            const sd = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
            const ed = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;
            const q = (document.getElementById('search').value || '').toLowerCase().trim();

            return rows.filter(r => {
                if (!r.date) return false;
                if (sd && r.date < sd) return false;
                if (ed && r.date > ed) return false;
                if (fc && r.client !== fc) return false;
                if (s !== 'All' && (r.status || '').toLowerCase() !== s.toLowerCase()) return false;
                if (d !== 'All') {
                    if (d === 'Yes' && !r.delivered) return false;
                    if (d === 'No' && r.delivered) return false;
                }
                if (q) {
                    const hay = `${r.client}|${r.size}|${r.type}|${r.manufacturer}`.toLowerCase();
                    if (!hay.includes(q)) return false;
                }
                return true;
            });
        }

        function groupByPeriod(rows) {
            const keyFn = { 'Monthly': ym, 'Quarterly': qtr, 'Half-Yearly': half, 'Yearly': yr }[document.getElementById('period').value];
            const m = new Map();
            for (const r of rows) {
                const k = keyFn(r.date);
                if (!m.has(k)) m.set(k, { period: k, orders: 0, open: 0, closed: 0, qty: 0, revenue: 0, cost: 0, profit: 0, got: 0, pending: 0 });
                const a = m.get(k);
                a.orders++; a.qty += r.qty; a.revenue += r.revenue; a.cost += r.cost; a.profit += r.profit; a.got += r.got; a.pending += r.pending;
                if ((r.status || '').toLowerCase() === 'open') a.open++; else if ((r.status || '').toLowerCase() === 'closed') a.closed++;
            }
            return [...m.values()].sort((x, y) => x.period.localeCompare(y.period));
        }

        const sumQty = (rows, key) => {
            const m = new Map();
            for (const r of rows) { const k = (r[key] || 'Unknown'); m.set(k, (m.get(k) || 0) + r.qty) }
            return [...m.entries()].sort((a, b) => b[1] - a[1]);
        }
        const countBy = (rows, key) => {
            const m = new Map();
            for (const r of rows) { const k = (r[key] || 'Unknown'); m.set(k, (m.get(k) || 0) + 1) }
            return [...m.entries()].sort((a, b) => b[1] - a[1]);
        }

        // Lookups
        function buildClientLookups() {
            const rateMap = new Map(); // client|size|||type -> sellRate
            const prefMap = new Map(); // client -> Set(manufacturer)
            for (const r of CLIENTS) {
                rateMap.set(`${r.client}|${keyST(r.size, r.type)}`, r.sellRate || 0);
                const s = prefMap.get(r.client) || new Set();
                r.pref.split(',').map(x => x.trim()).filter(Boolean).forEach(p => s.add(p));
                prefMap.set(r.client, s);
            }
            return { rateMap, prefMap }
        }

        function buildManuCost() {
            // maps: st -> Map(manu -> cost), and also min cost per st
            const costMap = new Map();
            const minCost = new Map();
            for (const r of MANU) {
                const st = keyST(r.size, r.type);
                const m = costMap.get(st) || new Map();
                m.set(r.manu, r.cost || 0);
                costMap.set(st, m);
                const cur = minCost.get(st); const v = r.cost || Infinity;
                if (cur === undefined || v < cur) minCost.set(st, v);
            }
            return { costMap, minCost }
        }

        // ====== Rendering ======
        function renderKPIs(rows) {
            const orders = rows.length,
                qty = rows.reduce((s, r) => s + r.qty, 0),
                rev = rows.reduce((s, r) => s + r.revenue, 0),
                cost = rows.reduce((s, r) => s + r.cost, 0),
                profit = rows.reduce((s, r) => s + r.profit, 0),
                pending = rows.reduce((s, r) => s + r.pending, 0),
                open = rows.filter(r => (r.status || '').toLowerCase() === 'open').length,
                closed = rows.filter(r => (r.status || '').toLowerCase() === 'closed').length;
            // --- NEW: Need to Pay split by Paid status ---
            const paidStr = s => (s || '').toString().trim().toLowerCase();

            // Paid = "Yes"
            const needPayPaidYes = rows
                .filter(r => paidStr(r.paid).startsWith('y')) // handles "Yes" / "yes"
                .reduce((s, r) => s + (r.needToPay || 0), 0);

            // Paid = "Not Yet"
            const needPayPaidNotYet = rows
                .filter(r => /^not\s*yet$/i.test((r.paid || '').toString().trim())) // exact "Not Yet"
                .reduce((s, r) => s + (r.needToPay || 0), 0);

            // Render to single card as "‚ÇπX | ‚ÇπY"
            document.getElementById('k_needpay_split').textContent =
                `${fmtMoney(needPayPaidYes)} | ${fmtMoney(needPayPaidNotYet)}`;


            // --- NEW: Profit split (Kavin | Vicky) ---
            // Split the *total profit* equally
            const kavinShare = profit / 2;
            const vickyShare = profit / 2;

            // Render as "‚ÇπA | ‚ÇπB"
            document.getElementById('k_profit_split').textContent =
                `${fmtMoney(kavinShare)} | ${fmtMoney(vickyShare)}`;

            // --- NEW: Investments (Kavin | Vicky) ---
            let investKavin = 0, investVicky = 0;
            for (const r of INVEST) {
                if (r.name.toLowerCase() === 'kavin') investKavin += r.amount;
                if (r.name.toLowerCase() === 'vicky') investVicky += r.amount;
            }

            document.getElementById('k_investments').textContent =
                `${fmtMoney(investKavin)} | ${fmtMoney(investVicky)}`;

            // --- NEW: Stereo Cost (respects Dashboard filters: Focus Client + Start/End Date) ---
            (() => {
                const fc = document.getElementById('focusClient').value;
                const sd = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value) : null;
                const ed = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value) : null;

                // Filter STEREO using client/date. (Status/Delivered don‚Äôt exist for Stereo sheet.)
                const filteredStereo = STEREO.filter(r => {
                    if (!r.date) return false;
                    if (sd && r.date < sd) return false;
                    if (ed && r.date > ed) return false;
                    if (fc && r.client !== fc) return false;
                    return true;
                });

                const stereoSum = filteredStereo.reduce((s, r) => s + (r.cost || 0), 0);
                document.getElementById('k_stereo').textContent = fmtMoney(stereoSum);
            })();

            const avgSell = qty ? (rev / qty) : 0; const avgCost = qty ? (cost / qty) : 0; const marginPct = avgSell ? ((avgSell - avgCost) / avgSell * 100) : 0;
            document.getElementById('k_orders').textContent = INR.format(orders);
            document.getElementById('k_qty').textContent = fmtQty(qty);
            document.getElementById('k_rev').textContent = fmtMoney(rev);
            document.getElementById('k_cost').textContent = fmtMoney(cost);
            document.getElementById('k_profit').textContent = fmtMoney(profit);
            document.getElementById('k_pending').textContent = fmtMoney(pending);
            document.getElementById('k_open').textContent = INR.format(open);
            document.getElementById('k_closed').textContent = INR.format(closed);
            document.getElementById('k_avgsp').textContent = `${fmtMoney(avgSell)} | ${fmtMoney(avgCost)} | ${marginPct ? marginPct.toFixed(1) : '0.0'}%`;
        }

        function renderPeriodTable(groups) {
            const thead = document.querySelector('#t_period thead'); const tbody = document.querySelector('#t_period tbody');
            thead.innerHTML = `<tr>
        <th>Period</th><th>Orders</th><th>Open</th><th>Closed</th>
        <th>Qty (kg)</th><th>Revenue (‚Çπ)</th><th>Cost (‚Çπ)</th><th>Profit (‚Çπ)</th>
        <th>Avg ‚Çπ/kg</th><th>Got (‚Çπ)</th><th>Credit (‚Çπ)</th>
      </tr>`
            tbody.innerHTML = groups.map(g => {
                const avg = g.qty ? (g.revenue / g.qty) : 0;
                return `<tr>
          <td><strong>${g.period}</strong></td>
          <td>${INR.format(g.orders)}</td>
          <td><span class="chip warn">${INR.format(g.open)}</span></td>
          <td><span class="chip ok">${INR.format(g.closed)}</span></td>
          <td>${fmtQty(g.qty)}</td>
          <td>${fmtMoney(g.revenue)}</td>
          <td>${fmtMoney(g.cost)}</td>
          <td>${fmtMoney(g.profit)}</td>
          <td>${fmtMoney(avg)}</td>
          <td>${fmtMoney(g.got)}</td>
          <td>${fmtMoney(g.pending)}</td>
        </tr>`
            }).join('');
        }

        function destroyCharts() { Object.values(charts).forEach(c => { try { c.destroy() } catch (_) { } }); for (const k of Object.keys(charts)) delete charts[k]; }

        function commonBar() {
            const gridColor = '#2a3a5d', tickColor = '#9fb0d0';
            return {
                responsive: true, maintainAspectRatio: false, animation: { duration: 300 },
                plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0b1020', borderColor: '#223354', borderWidth: 1 } },
                scales: {
                    x: { ticks: { color: tickColor, autoSkip: true, maxRotation: 45 }, grid: { color: gridColor, drawOnChartArea: false } },
                    y: { ticks: { color: tickColor, callback: v => INR.format(v) }, grid: { color: gridColor } }
                }
            }
        }

        function renderTrendCharts(groups) {
            const labels = groups.map(g => g.period);
            const rev = groups.map(g => Math.round(g.revenue));
            const cost = groups.map(g => Math.round(g.cost));
            const profit = groups.map(g => Math.round(g.profit));
            destroyCharts();
            charts.revCost = new Chart(document.getElementById('c_rev_cost'), {
                type: 'line', data: {
                    labels, datasets: [
                        { label: 'Revenue', data: rev }, { label: 'Cost', data: cost }
                    ]
                }, options: {
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#9fb0d0' } }, tooltip: { backgroundColor: '#0b1020', borderColor: '#223354', borderWidth: 1 } },
                    scales: { x: { ticks: { color: '#9fb0d0' } }, y: { ticks: { color: '#9fb0d0', callback: v => INR.format(v) } } }
                }
            });
            charts.profit = new Chart(document.getElementById('c_profit'), {
                type: 'bar', data: { labels, datasets: [{ label: 'Profit', data: profit }] }, options: commonBar()
            });
        }

        function renderDistributions(rows) {
            const byManu = sumQty(rows, 'manufacturer').slice(0, 12);
            const byType = sumQty(rows, 'type').slice(0, 12);
            const bySize = sumQty(rows, 'size').slice(0, 18);
            charts.byManu = new Chart(document.getElementById('c_by_manu'), { type: 'bar', data: { labels: byManu.map(d => d[0]), datasets: [{ label: 'Kg', data: byManu.map(d => d[1]) }] }, options: commonBar() });
            charts.byType = new Chart(document.getElementById('c_by_type'), { type: 'bar', data: { labels: byType.map(d => d[0]), datasets: [{ label: 'Kg', data: byType.map(d => d[1]) }] }, options: commonBar() });
            charts.bySize = new Chart(document.getElementById('c_by_size'), { type: 'bar', data: { labels: bySize.map(d => d[0]), datasets: [{ label: 'Kg', data: bySize.map(d => d[1]) }] }, options: commonBar() });

            const byStatus = countBy(rows, 'status');
            const delivered = rows.reduce((a, r) => { const k = r.delivered ? 'Delivered' : 'Not Delivered'; a[k] = (a[k] || 0) + 1; return a }, {});
            charts.status = new Chart(document.getElementById('c_status'), { type: 'doughnut', data: { labels: byStatus.map(d => d[0]), datasets: [{ data: byStatus.map(d => d[1]) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#9fb0d0' } } } } });
            charts.delivery = new Chart(document.getElementById('c_delivery'), { type: 'doughnut', data: { labels: Object.keys(delivered), datasets: [{ data: Object.values(delivered) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#9fb0d0' } } } } });
        }

        function renderClientIntel(rows) {
            const focus = document.getElementById('focusClient').value;
            const rowsFor = focus ? rows.filter(r => r.client === focus) : rows;

            // Top clients by qty
            const topClients = sumQty(rows, 'client').slice(0, 12);
            charts.clientTop = new Chart(document.getElementById('c_client_top'), { type: 'bar', data: { labels: topClients.map(d => d[0]), datasets: [{ label: 'Kg', data: topClients.map(d => d[1]) }] }, options: commonBar() });

            // Focus client distributions
            const cSize = sumQty(rowsFor, 'size').slice(0, 12);
            charts.clientSize = new Chart(document.getElementById('c_client_size'), { type: 'bar', data: { labels: cSize.map(d => d[0]), datasets: [{ label: 'Kg', data: cSize.map(d => d[1]) }] }, options: commonBar() });
            const cType = sumQty(rowsFor, 'type').slice(0, 12);
            charts.clientType = new Chart(document.getElementById('c_client_type'), { type: 'bar', data: { labels: cType.map(d => d[0]), datasets: [{ label: 'Kg', data: cType.map(d => d[1]) }] }, options: commonBar() });

            // Size -> Manufacturer mix (stacked) for top sizes overall
            const sizesTop = sumQty(rows, 'size').slice(0, 8).map(s => s[0]);
            const manuBySize = new Map();
            for (const r of rows) { if (!sizesTop.includes(r.size)) continue; const m = manuBySize.get(r.size) || new Map(); m.set(r.manufacturer, (m.get(r.manufacturer) || 0) + r.qty); manuBySize.set(r.size, m); }
            const manuSet = new Set(); manuBySize.forEach(m => m.forEach((_, k) => manuSet.add(k)));
            const labels = sizesTop, manus = [...manuSet];
            const datasets = manus.map((m, i) => ({ label: m, data: labels.map(sz => (manuBySize.get(sz)?.get(m) || 0)) }));
            charts.sizeManu = new Chart(document.getElementById('c_size_manu'), { type: 'bar', data: { labels, datasets }, options: { ...commonBar(), plugins: { legend: { position: 'bottom', labels: { color: '#9fb0d0' } } }, scales: { x: { ...commonBar().scales.x, stacked: true }, y: { ...commonBar().scales.y, stacked: true } } } });

            // Client Insights table (logical)
            const { rateMap, prefMap } = buildClientLookups();
            const tbody = document.querySelector('#t_clients tbody');
            const byClient = new Map(); // client -> agg
            for (const r of rows) {
                const a = byClient.get(r.client) || { qty: 0, rev: 0, cost: 0, profit: 0, last: null, size: new Map(), type: new Map(), manu: new Map(), delivered: 0, total: 0 };
                a.qty += r.qty; a.rev += r.revenue; a.cost += r.cost; a.profit += r.profit; a.total++;
                if (r.delivered) a.delivered++;
                if (!a.last || r.date > a.last) a.last = r.date;
                a.size.set(r.size, (a.size.get(r.size) || 0) + r.qty);
                a.type.set(r.type, (a.type.get(r.type) || 0) + r.qty);
                a.manu.set(r.manufacturer, (a.manu.get(r.manufacturer) || 0) + r.qty);
                byClient.set(r.client, a);
            }
            function topEntry(map) { let best = ['-', 0]; for (const [k, v] of map.entries()) { if (v > best[1]) best = [k, v] } return best[0] }
            const ninetyDays = 1000 * 60 * 60 * 24 * 90; const now = new Date();
            const lines = [];
            for (const [client, a] of byClient.entries()) {
                const avg = a.qty ? a.rev / a.qty : 0;
                const topSize = topEntry(a.size); const topType = topEntry(a.type);
                const realizedTop = (() => {
                    // avg sell price for orders matching top size+type
                    let q = 0, rev = 0; for (const r of rows) { if (r.client === client && r.size === topSize && r.type === topType) { q += r.qty; rev += r.revenue } }
                    return q ? (rev / q) : 0;
                })();
                const configured = rateMap.get(`${client}|${keyST(topSize, topType)}`) || 0;
                const prefs = [...(prefMap.get(client) || new Set())].join(', ');
                const topManu = topEntry(a.manu);
                const adherence = prefs ? (prefs.split(',').map(s => s.trim()).includes(topManu) ? 'Yes' : 'No') : 'n/a';
                const lastStr = a.last ? a.last.toISOString().slice(0, 10) : '-';
                const churn = a.last ? ((now - a.last) > ninetyDays ? 'High' : 'Low') : '‚Äî';
                lines.push(`<tr>
          <td><strong>${client || '-'}</strong></td>
          <td>${fmtQty(a.qty)}</td>
          <td>${fmtMoney(a.rev)}</td>
          <td>${fmtMoney(a.profit)}</td>
          <td>${fmtMoney(avg)}</td>
          <td>${topSize || '-'}</td>
          <td>${topType || '-'}</td>
          <td>${realizedTop ? fmtMoney(realizedTop) : '<span class="muted">n/a</span>'}</td>
          <td>${configured ? fmtMoney(configured) : '<span class="muted">n/a</span>'}</td>
          <td>${prefs || '<span class="muted">None</span>'}</td>
          <td>${topManu || '-'}</td>
          <td>${adherence === 'Yes' ? '<span class="chip ok">Yes</span>' : (adherence === 'No' ? '<span class="chip bad">No</span>' : '<span class="chip">n/a</span>')}</td>
          <td>${lastStr}</td>
          <td>${churn === 'High' ? '<span class="chip bad">High</span>' : '<span class="chip ok">Low</span>'}</td>
        </tr>`);
            }
            tbody.innerHTML = lines.sort().join('') || `<tr><td colspan="14" class="muted" style="text-align:center">No client data</td></tr>`;
        }

        function renderMapping(rows) {
            const { costMap, minCost } = buildManuCost();
            const byST = new Map(); // st -> Map(manu->qty)
            for (const r of rows) { const st = keyST(r.size, r.type); const m = byST.get(st) || new Map(); m.set(r.manufacturer, (m.get(r.manufacturer) || 0) + r.qty); byST.set(st, m) }
            const tbody = document.querySelector('#t_mapping tbody');
            const lines = [];
            for (const [st, mm] of byST.entries()) {
                const [size, type] = st.split('|||');
                // historical top
                let top = ['-', 0]; mm.forEach((v, k) => { if (v > top[1]) top = [k, v] });
                // preferred union across clients who bought this ST
                const prefsSet = new Set();
                for (const c of CLIENTS) { if (c.size === size && c.type === type) { c.pref.split(',').map(s => s.trim()).filter(Boolean).forEach(p => prefsSet.add(p)) } }
                const prefs = [...prefsSet];
                // recommended: if any preferred manu has cost info choose the lowest cost among preferred; else global lowest cost
                const cm = costMap.get(st) || new Map();
                let rec = null; let best = Infinity;
                const candidates = prefs.length ? prefs : [...cm.keys()];
                for (const m of candidates) { const cost = cm.get(m); if (typeof cost === 'number' && cost >= 0 && cost < best) { best = cost; rec = m } }
                if (rec === null) { // fallback: use global min cost value but unknown manu
                    // try to find which manu has minCost
                    const mc = minCost.get(st);
                    if (mc !== undefined) {
                        for (const [m, c] of (cm.entries())) { if (c === mc) { rec = m; best = c; break } }
                        if (rec === null) { rec = '‚Äî'; best = mc }
                    } else { rec = '‚Äî'; best = 0 }
                }
                lines.push(`<tr>
          <td>${size}</td>
          <td>${type}</td>
          <td>${top[0]}</td>
          <td>${prefs.length ? prefs.join(', ') : '<span class="muted">‚Äî</span>'}</td>
          <td>${rec}</td>
          <td>${best ? '‚Çπ' + INR.format(best) : '<span class="muted">n/a</span>'}</td>
        </tr>`)
            }
            tbody.innerHTML = lines.sort().join('') || `<tr><td colspan="6" class="muted" style="text-align:center">No mapping data</td></tr>`;
        }

        // Report CSV (current filtered data + period summary)
        function downloadReport(rows, groups) {
            const header = ['Order ID', 'Date', 'Client', 'Size', 'Type', 'Qty (kg)', 'Manufacturer', 'Delivered', 'Status', 'Sell ‚Çπ/kg', 'Cost ‚Çπ/kg', 'Revenue ‚Çπ', 'Cost ‚Çπ', 'Profit ‚Çπ', 'Pending ‚Çπ'];
            const lines = rows.map(r => [
                r.orderID, r.date ? r.date.toISOString().slice(0, 10) : '', r.client, r.size, r.type, r.qty, r.manufacturer, r.delivered ? 'Yes' : 'No', r.status,
                r.sellPrice, r.costPrice, Math.round(r.revenue), Math.round(r.cost), Math.round(r.profit), Math.round(r.pending)
            ]);
            lines.unshift(header);
            // add a blank and then period summary
            lines.push([]);
            lines.push(['Period', 'Orders', 'Open', 'Closed', 'Qty', 'Revenue', 'Cost', 'Profit', 'Avg ‚Çπ/kg', 'Got', 'Credit']);
            for (const g of groups) { lines.push([g.period, g.orders, g.open, g.closed, Math.round(g.qty), Math.round(g.revenue), Math.round(g.cost), Math.round(g.profit), g.qty ? Math.round(g.revenue / g.qty) : 0, Math.round(g.got), Math.round(g.pending)]) }
            const csv = lines.map(row => row.map(x => (x === undefined || x === null) ? '' : String(x).includes(',') ? '"' + String(x).replace(/"/g, '""') + '"' : String(x)).join(',')).join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = 'biobags_report.csv'; document.body.appendChild(a); a.click(); a.remove();
        }

        // ====== Refresh ======
        function refresh() {
            try {
                if (ORDERS.length === 0) { setError('No data. Make sure the sheets are public (Anyone with the link ‚Üí Viewer).'); return; }
                setError(null);
                const filtered = applyFilters(ORDERS);
                const groups = groupByPeriod(filtered);
                renderKPIs(filtered);
                renderPeriodTable(groups);
                renderTrendCharts(groups);
                renderDistributions(filtered);
                renderClientIntel(filtered);
                renderMapping(filtered);
                // resize charts on container resize
                requestAnimationFrame(() => { Object.values(charts).forEach(c => c && c.resize && c.resize()) });
                return { filtered, groups }
            } catch (e) { setError('Error: ' + e.message) }
        }

        // ====== Events ======
        document.getElementById('reload').addEventListener('click', async () => { show('loading', true); try { await loadAll(); refresh() } catch (e) { setError(e.message) } finally { show('loading', false) } });
        document.getElementById('reset').addEventListener('click', () => {
            document.getElementById('period').value = 'Monthly';
            document.getElementById('startDate').value = ''; document.getElementById('endDate').value = '';
            document.getElementById('status').value = 'All'; document.getElementById('delivered').value = 'All';
            document.getElementById('focusClient').value = ''; document.getElementById('search').value = '';
            refresh();
        });
        ['period', 'status', 'delivered', 'startDate', 'endDate', 'focusClient', 'search'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => refresh());
            document.getElementById(id).addEventListener('change', () => refresh());
        });
        document.getElementById('download').addEventListener('click', () => { const r = refresh(); if (r) downloadReport(r.filtered, r.groups) });

        // keep charts crisp when panels resize
        const ro = new ResizeObserver(() => { Object.values(charts).forEach(c => c && c.resize && c.resize()) });
        document.querySelectorAll('.chart-wrap').forEach(el => ro.observe(el));

        // Init
        (async function () { try { await loadAll(); refresh() } catch (e) { setError('Load error: ' + e.message); show('loading', false) } })();

        // ===== Reports utils =====
        const monthStartEnd = (yyyyMM) => {
            if (!yyyyMM) return [null, null];
            const [y, m] = yyyyMM.split('-').map(n => +n);
            const start = new Date(y, m - 1, 1);
            const end = new Date(y, m, 0); // last day of month
            end.setHours(23, 59, 59, 999);
            return [start, end];
        };
        const txt = (v) => (v == null || v === undefined || v === '') ? '' : String(v);
        const pushRows = (el, rowsHtml, emptyCols = 3, emptyMsg = 'No data') => {
            el.innerHTML = rowsHtml || `<tr><td colspan="${emptyCols}" class="muted" style="text-align:center">${emptyMsg}</td></tr>`;
        };


        // ===== Tabs: Dashboard / Reports
        const $dash = document.getElementById('dashboard');
        const $reps = document.getElementById('reports');
        function showTab(which) {
            if (which === 'reports') {
                $dash.style.display = 'none';
                $reps.style.display = 'block';
            } else {
                $dash.style.display = 'block';
                $reps.style.display = 'none';
            }
            // optional: visual state on buttons
            // highlight active tab
            document.getElementById('tabDashboard').classList.remove('active');
            document.getElementById('tabReports').classList.remove('active');

            if (which === 'dashboard') {
                document.getElementById('tabDashboard').classList.add('active');
            } else {
                document.getElementById('tabReports').classList.add('active');
            }
        }
        document.getElementById('tabDashboard').addEventListener('click', () => showTab('dashboard'));
        document.getElementById('tabReports').addEventListener('click', () => {
            showTab('reports');
            initPeriodPicker();    // <-- add this line
            buildReports();
        });

        document.getElementById('tabDashboard').classList.add('active');

        function applyReportFilters(rows) {
            const fc = document.getElementById('r_client').value;
            const fm = document.getElementById('r_manu').value;

            // NEW: type/value come from the period picker
            const type = document.getElementById('r_period_type').value;
            const value = document.getElementById('r_period_value').value;
            const [ms, me] = getPeriodBounds(type, value);

            const q = (document.getElementById('r_search')?.value || '').toLowerCase().trim();

            return rows.filter(r => {
                if (!r.date) return false;
                if (fc && r.client !== fc) return false;
                if (fm && r.manufacturer !== fm) return false;

                // When "All time", ms & me are null ‚áí no date filter
                if (ms && r.date < ms) return false;
                if (me && r.date > me) return false;

                if (q) {
                    const hay = `${r.client}|${r.size}|${r.type}|${r.manufacturer}|${r.orderID}`.toLowerCase();
                    if (!hay.includes(q)) return false;
                }
                return true;
            });
        }



        function groupSum(rows, key) {
            const m = new Map();
            for (const r of rows) {
                const k = r[key] || 'Unknown';
                m.set(k, (m.get(k) || 0) + r.qty);
            }
            return [...m.entries()].sort((a, b) => b[1] - a[1]);
        }

        function money(n) { return '‚Çπ' + INR.format(Math.round(n || 0)); }
        function qtyfmt(n) { return INR.format(Math.round((n || 0) * 100) / 100); }

        function renderClientReport(filtered) {
            const fc = document.getElementById('r_client').value;
            const rows = fc ? filtered.filter(r => r.client === fc) : filtered;

            // Summary (single row)
            tableRenderers.t_client_summary = () => {
                const orders = rows.length;
                const qty = rows.reduce((s, r) => s + r.qty, 0);
                const rev = rows.reduce((s, r) => s + r.revenue, 0);
                const cost = rows.reduce((s, r) => s + r.cost, 0);
                const profit = rows.reduce((s, r) => s + r.profit, 0);
                const got = rows.reduce((s, r) => s + r.got, 0);
                const pending = rows.reduce((s, r) => s + r.pending, 0);
                const avgSell = qty ? (rev / qty) : 0;
                const avgCost = qty ? (cost / qty) : 0;
                const margin = avgSell ? ((avgSell - avgCost) / avgSell * 100) : 0;
                const last = rows.reduce((mx, r) => (!mx || r.date > mx) ? r.date : mx, null);

                const thead = `<tr>
      <th>Client</th><th>Orders</th><th>Qty (kg)</th><th>Revenue</th><th>Cost</th><th>Profit</th>
      <th>Avg Sell ‚Çπ/kg</th><th>Avg Cost ‚Çπ/kg</th><th>Margin %</th><th>Got</th><th>Pending</th><th>Last Order</th>
    </tr>`;
                const tr = `<tr>
      <td><strong>${fc || 'All'}</strong></td>
      <td>${INR.format(orders)}</td>
      <td>${fmtQty(qty)}</td>
      <td>${fmtMoney(rev)}</td>
      <td>${fmtMoney(cost)}</td>
      <td>${fmtMoney(profit)}</td>
      <td>${fmtMoney(avgSell)}</td>
      <td>${fmtMoney(avgCost)}</td>
      <td>${margin ? margin.toFixed(1) : '0.0'}%</td>
      <td>${fmtMoney(got)}</td>
      <td>${fmtMoney(pending)}</td>
      <td>${last ? last.toISOString().slice(0, 10) : '-'}</td>
    </tr>`;
                return { thead, rows: [tr] };
            };
            pagers.t_client_summary = { page: 1, total: 1 };
            reRenderTable('t_client_summary');

            // Size Mix
            tableRenderers.t_client_size = () => {
                const groups = groupSum(rows, 'size');
                const thead = `<tr><th>Size</th><th>Qty (kg)</th></tr>`;
                const bodyRows = groups.map(([k, v]) => `<tr><td>${k}</td><td>${fmtQty(v)}</td></tr>`);
                return { thead, rows: bodyRows };
            };
            pagers.t_client_size = { page: 1, total: 1 };
            reRenderTable('t_client_size');

            // Type Mix
            tableRenderers.t_client_type = () => {
                const groups = groupSum(rows, 'type');
                const thead = `<tr><th>Type</th><th>Qty (kg)</th></tr>`;
                const bodyRows = groups.map(([k, v]) => `<tr><td>${k}</td><td>${fmtQty(v)}</td></tr>`);
                return { thead, rows: bodyRows };
            };
            pagers.t_client_type = { page: 1, total: 1 };
            reRenderTable('t_client_type');
        }

        function renderManuReport(filtered) {
            const fm = document.getElementById('r_manu').value;
            const rows = fm ? filtered.filter(r => r.manufacturer === fm) : filtered;

            // Summary (single row)
            tableRenderers.t_manu_summary = () => {
                const orders = rows.length;
                const qty = rows.reduce((s, r) => s + r.qty, 0);
                const rev = rows.reduce((s, r) => s + r.revenue, 0);
                const cost = rows.reduce((s, r) => s + r.cost, 0);
                const profit = rows.reduce((s, r) => s + r.profit, 0);
                const got = rows.reduce((s, r) => s + r.got, 0);
                const pending = rows.reduce((s, r) => s + r.pending, 0);
                const avgSell = qty ? (rev / qty) : 0;
                const avgCost = qty ? (cost / qty) : 0;
                const margin = avgSell ? ((avgSell - avgCost) / avgSell * 100) : 0;
                const last = rows.reduce((mx, r) => (!mx || r.date > mx) ? r.date : mx, null);

                const thead = `<tr>
      <th>Manufacturer</th><th>Orders</th><th>Qty (kg)</th><th>Revenue</th><th>Cost</th><th>Profit</th>
      <th>Avg Sell ‚Çπ/kg</th><th>Avg Cost ‚Çπ/kg</th><th>Margin %</th><th>Got</th><th>Pending</th><th>Last Order</th>
    </tr>`;
                const tr = `<tr>
      <td><strong>${fm || 'All'}</strong></td>
      <td>${INR.format(orders)}</td>
      <td>${fmtQty(qty)}</td>
      <td>${fmtMoney(rev)}</td>
      <td>${fmtMoney(cost)}</td>
      <td>${fmtMoney(profit)}</td>
      <td>${fmtMoney(avgSell)}</td>
      <td>${fmtMoney(avgCost)}</td>
      <td>${margin ? margin.toFixed(1) : '0.0'}%</td>
      <td>${fmtMoney(got)}</td>
      <td>${fmtMoney(pending)}</td>
      <td>${last ? last.toISOString().slice(0, 10) : '-'}</td>
    </tr>`;
                return { thead, rows: [tr] };
            };
            pagers.t_manu_summary = { page: 1, total: 1 };
            reRenderTable('t_manu_summary');

            // Clients (by Qty)
            tableRenderers.t_manu_clients = () => {
                const byClient = rows.reduce((m, r) => (m.set(r.client, (m.get(r.client) || 0) + r.qty), m), new Map());
                const list = [...byClient.entries()].sort((a, b) => b[1] - a[1]);
                const thead = `<tr><th>Client</th><th>Qty (kg)</th></tr>`;
                const bodyRows = list.map(([k, v]) => `<tr><td>${k || '-'}</td><td>${fmtQty(v)}</td></tr>`);
                return { thead, rows: bodyRows };
            };
            pagers.t_manu_clients = { page: 1, total: 1 };
            reRenderTable('t_manu_clients');

            // Size Mix
            tableRenderers.t_manu_size = () => {
                const groups = groupSum(rows, 'size');
                const thead = `<tr><th>Size</th><th>Qty (kg)</th></tr>`;
                const bodyRows = groups.map(([k, v]) => `<tr><td>${k}</td><td>${fmtQty(v)}</td></tr>`);
                return { thead, rows: bodyRows };
            };
            pagers.t_manu_size = { page: 1, total: 1 };
            reRenderTable('t_manu_size');

            // Type Mix
            tableRenderers.t_manu_type = () => {
                const groups = groupSum(rows, 'type');
                const thead = `<tr><th>Type</th><th>Qty (kg)</th></tr>`;
                const bodyRows = groups.map(([k, v]) => `<tr><td>${k}</td><td>${fmtQty(v)}</td></tr>`);
                return { thead, rows: bodyRows };
            };
            pagers.t_manu_type = { page: 1, total: 1 };
            reRenderTable('t_manu_type');
        }


        function buildReports() {
            // Start from the full data, then apply report filters
            const filtered = applyReportFilters(ORDERS);
            renderClientReport(filtered);
            renderManuReport(filtered);
        }

        // Export CSV for reports (current filtered view)
        function downloadReportCSV() {
            const filtered = applyReportFilters(ORDERS);
            const header = ['Order ID', 'Date', 'Client', 'Size', 'Type', 'Qty (kg)', 'Manufacturer', 'Delivered', 'Status', 'Sell ‚Çπ/kg', 'Cost ‚Çπ/kg', 'Revenue ‚Çπ', 'Cost ‚Çπ', 'Profit ‚Çπ', 'Pending ‚Çπ'];
            const rows = filtered.map(r => [
                r.orderID, r.date ? r.date.toISOString().slice(0, 10) : '', r.client, r.size, r.type, r.qty, r.manufacturer,
                r.delivered ? 'Yes' : 'No', r.status, r.sellPrice, r.costPrice, Math.round(r.revenue), Math.round(r.cost), Math.round(r.profit), Math.round(r.pending)
            ]);
            rows.unshift(header);
            const csv = rows.map(row => row.map(x => (x === undefined || x === null) ? '' : String(x).includes(',') ? `"${String(x).replace(/"/g, '""')}"` : String(x)).join(',')).join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = 'biobags_reports.csv';
            document.body.appendChild(a); a.click(); a.remove();
        }


        // ===== Reports events
        document.getElementById('r_refresh').addEventListener('click', buildReports);
        document.getElementById('r_download').addEventListener('click', downloadReportCSV);
        document.getElementById('r_reset').addEventListener('click', () => {
            document.getElementById('r_client').value = '';
            document.getElementById('r_manu').value = '';
            document.getElementById('r_month').value = '';
            document.getElementById('r_search').value = '';
            buildReports();
        });
        ['r_client', 'r_manu', 'r_period_type', 'r_period_value', 'r_search'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', buildReports);
            el.addEventListener('change', buildReports);
        });


        // ===== Pagination (10 rows/page) =====
        const PAGE_SIZE = 10;
        const pagers = {}; // tableId -> { page, total }

        function slicePage(rows, page, size = PAGE_SIZE) {
            const start = (page - 1) * size;
            return rows.slice(start, start + size);
        }

        function renderPager(tableId, totalRows) {
            const totalPages = Math.max(1, Math.ceil(totalRows / PAGE_SIZE));
            const state = pagers[tableId] || { page: 1, total: totalPages };
            state.total = totalPages;
            if (state.page > totalPages) state.page = totalPages;
            if (state.page < 1) state.page = 1;
            pagers[tableId] = state;

            const host = document.getElementById('p_' + tableId);
            if (!host) return;

            host.innerHTML = '';
            const prev = document.createElement('button');
            prev.textContent = '‚Äπ Prev';
            prev.disabled = state.page <= 1;
            prev.addEventListener('click', () => { pagers[tableId].page--; reRenderTable(tableId); });

            const next = document.createElement('button');
            next.textContent = 'Next ‚Ä∫';
            next.disabled = state.page >= totalPages;
            next.addEventListener('click', () => { pagers[tableId].page++; reRenderTable(tableId); });

            const info = document.createElement('span'); info.className = 'info';
            info.textContent = `Page ${state.page} / ${totalPages} ‚Ä¢ ${totalRows} rows`;

            host.appendChild(prev);
            host.appendChild(next);
            host.appendChild(info);
        }

        // registry of table re-render functions
        const tableRenderers = {}; // tableId -> function returning {thead, rows[]}

        function reRenderTable(tableId) {
            const fn = tableRenderers[tableId];
            if (!fn) return;
            const { thead, rows } = fn(); // fresh data under current filters
            const tbodyEl = document.querySelector(`#${tableId} tbody`);
            const theadEl = document.querySelector(`#${tableId} thead`);
            theadEl.innerHTML = thead;

            const page = (pagers[tableId]?.page) || 1;
            const portion = slicePage(rows, page);
            tbodyEl.innerHTML = portion.join('') || `<tr><td class="muted" colspan="99" style="text-align:center">No data</td></tr>`;

            renderPager(tableId, rows.length);
        }


        function renderSharedOrders(filteredRows) {
            tableRenderers.t_orders_shared = () => {
                const thead = `<tr>
      <th>Order ID</th><th>Date</th><th>Client</th><th>Size</th><th>Type</th><th>Qty (kg)</th>
      <th>Manufacturer</th><th>Delivered</th><th>Status</th>
      <th>Sell ‚Çπ/kg</th><th>Cost ‚Çπ/kg</th><th>Revenue</th><th>Cost</th><th>Profit</th><th>Pending</th>
    </tr>`;

                const rows = filteredRows.map(r => `<tr>
      <td>${(r.orderID || '')}</td>
      <td>${r.date ? r.date.toISOString().slice(0, 10) : ''}</td>
      <td>${(r.client || '')}</td>
      <td>${(r.size || '')}</td>
      <td>${(r.type || '')}</td>
      <td>${fmtQty(r.qty)}</td>
      <td>${(r.manufacturer || '')}</td>
      <td>${r.delivered ? '<span class="chip ok">Yes</span>' : '<span class="chip warn">No</span>'}</td>
      <td>${(r.status || '')}</td>
      <td>${fmtMoney(r.sellPrice)}</td>
      <td>${fmtMoney(r.costPrice)}</td>
      <td>${fmtMoney(r.revenue)}</td>
      <td>${fmtMoney(r.cost)}</td>
      <td>${fmtMoney(r.profit)}</td>
      <td>${fmtMoney(r.pending)}</td>
    </tr>`);

                return { thead, rows };
            };
            // Keep page when filters change? You can reset like below:
            pagers.t_orders_shared = { page: 1, total: 1 };
            reRenderTable('t_orders_shared');
        }


        function buildReports() {
            const filtered = applyReportFilters(ORDERS);

            // Client side tables
            renderClientReport(filtered);

            // Manufacturer side tables
            renderManuReport(filtered);

            // Shared orders table
            renderSharedOrders(filtered);
        }
        ['r_client', 'r_manu', 'r_period_type', 'r_period_value', 'r_search'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', buildReports);
            el.addEventListener('change', buildReports);
        });


        // ===== Period helpers (Month / Quarter / Half-Year / Year) =====
        function startOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }
        function endOfMonth(d) { return new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59, 999); }

        function startOfQuarter(d) {
            const qStart = d.getMonth() - (d.getMonth() % 3);
            return new Date(d.getFullYear(), qStart, 1);
        }
        function endOfQuarter(d) {
            const s = startOfQuarter(d);
            return new Date(s.getFullYear(), s.getMonth() + 3, 0, 23, 59, 59, 999);
        }

        function startOfHalf(d) {
            const hStart = (d.getMonth() < 6) ? 0 : 6;
            return new Date(d.getFullYear(), hStart, 1);
        }
        function endOfHalf(d) {
            const s = startOfHalf(d);
            return new Date(s.getFullYear(), s.getMonth() + 6, 0, 23, 59, 59, 999);
        }

        function startOfYear(d) { return new Date(d.getFullYear(), 0, 1); }
        function endOfYear(d) { return new Date(d.getFullYear(), 11, 31, 23, 59, 59, 999); }

        function formatLabelFor(type, d) {
            if (type === 'month') return d.toLocaleString(undefined, { month: 'long', year: 'numeric' });
            if (type === 'quarter') return `Q${Math.floor(d.getMonth() / 3) + 1} ${d.getFullYear()}`;
            if (type === 'half') return `${d.getMonth() < 6 ? 'H1' : 'H2'} ${d.getFullYear()}`;
            return String(d.getFullYear()); // year
        }

        function canonicalValueFor(type, d) {
            const y = d.getFullYear();
            if (type === 'month') return `${y}-${String(d.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
            if (type === 'quarter') return `${y}-Q${Math.floor(d.getMonth() / 3) + 1}`;          // YYYY-Q#
            if (type === 'half') return `${y}-H${d.getMonth() < 6 ? 1 : 2}`;                // YYYY-H#
            return String(y);                                                                  // YYYY
        }

        function parseCanonical(type, val) {
            if (!val) return null;
            try {
                if (type === 'month') {
                    const [y, m] = val.split('-'); return new Date(+y, +m - 1, 1);
                }
                if (type === 'quarter') {
                    const [y, q] = val.split('-Q'); return new Date(+y, ((+q - 1) * 3), 1);
                }
                if (type === 'half') {
                    const [y, h] = val.split('-H'); return new Date(+y, (+h === 1 ? 0 : 6), 1);
                }
                return new Date(+val, 0, 1); // year
            } catch { return null; }
        }

        function addPeriod(type, d, delta) {
            if (type === 'month') return new Date(d.getFullYear(), d.getMonth() + delta, 1);
            if (type === 'quarter') return new Date(d.getFullYear(), d.getMonth() + 3 * delta, 1);
            if (type === 'half') return new Date(d.getFullYear(), d.getMonth() + 6 * delta, 1);
            return new Date(d.getFullYear() + delta, 0, 1); // year
        }

        function periodStartEnd(type, val) {
            const anchor = parseCanonical(type, val);
            if (!anchor) return [null, null];
            if (type === 'month') return [startOfMonth(anchor), endOfMonth(anchor)];
            if (type === 'quarter') return [startOfQuarter(anchor), endOfQuarter(anchor)];
            if (type === 'half') return [startOfHalf(anchor), endOfHalf(anchor)];
            return [startOfYear(anchor), endOfYear(anchor)];
        }

        // ===== Period picker controller =====
        function setPeriodValue(type, dateObj, fire = true) {
            const $val = document.getElementById('r_period_value');
            const $lab = document.getElementById('mp_label');
            $val.value = canonicalValueFor(type, dateObj);
            $lab.textContent = formatLabelFor(type, dateObj);
            if (fire) {
                $val.dispatchEvent(new Event('input', { bubbles: true }));
                $val.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }

        function initPeriodPicker() {
            const $type = document.getElementById('r_period_type');
            const $prev = document.getElementById('mp_prev');
            const $next = document.getElementById('mp_next');

            let curType = $type.value;
            let cur = new Date(); // default to current period
            cur = (curType === 'month') ? startOfMonth(cur)
                : (curType === 'quarter') ? startOfQuarter(cur)
                    : (curType === 'half') ? startOfHalf(cur)
                        : startOfYear(cur);

            setPeriodValue(curType, cur, false);

            $type.addEventListener('change', () => {
                curType = $type.value;
                // snap anchor to the start of the chosen period of "today"
                let now = new Date();
                cur = (curType === 'month') ? startOfMonth(now)
                    : (curType === 'quarter') ? startOfQuarter(now)
                        : (curType === 'half') ? startOfHalf(now)
                            : startOfYear(now);
                setPeriodValue(curType, cur);  // triggers buildReports via existing listeners
            });

            $prev.addEventListener('click', () => {
                cur = addPeriod(curType, cur, -1);
                setPeriodValue(curType, cur);
            });
            $next.addEventListener('click', () => {
                cur = addPeriod(curType, cur, +1);
                setPeriodValue(curType, cur);
            });
        }

        // Label to show in the big chip
        function formatPeriodLabel(type, value) {
            if (type === 'all') return 'All time';
            if (type === 'month') {
                const [y, m] = value.split('-').map(Number);
                const d = new Date(y, m - 1, 1);
                return d.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            }
            if (type === 'quarter') {
                const [y, q] = value.split('-Q').map(Number);
                return `Q${q} ${y}`;
            }
            if (type === 'half') {
                const [y, h] = value.split('-H').map(Number);
                return `H${h} ${y}`;
            }
            if (type === 'year') {
                return value; // "2025"
            }
            return '‚Äî';
        }

        // Date bounds for filtering
        function getPeriodBounds(type, value) {
            if (type === 'all') return [null, null];

            if (type === 'month') {
                const [y, m] = value.split('-').map(Number);
                const start = new Date(y, m - 1, 1);
                const end = new Date(y, m, 0);
                end.setHours(23, 59, 59, 999);
                return [start, end];
            }
            if (type === 'quarter') {
                const [y, q] = value.split('-Q').map(Number);
                const startMonth = (q - 1) * 3;
                const start = new Date(y, startMonth, 1);
                const end = new Date(y, startMonth + 3, 0);
                end.setHours(23, 59, 59, 999);
                return [start, end];
            }
            if (type === 'half') {
                const [y, h] = value.split('-H').map(Number);
                const startMonth = (h === 1 ? 0 : 6);
                const start = new Date(y, startMonth, 1);
                const end = new Date(y, startMonth + 6, 0);
                end.setHours(23, 59, 59, 999);
                return [start, end];
            }
            if (type === 'year') {
                const y = Number(value);
                const start = new Date(y, 0, 1);
                const end = new Date(y, 12, 0);
                end.setHours(23, 59, 59, 999);
                return [start, end];
            }
            return [null, null];
        }

        // Step backward/forward when clicking ‚Äπ ‚Ä∫
        // Return the next period "value" string for the current type
        function stepPeriod(type, value, dir /* -1 or +1 */) {
            if (type === 'all') return value; // no-op

            if (type === 'month') {
                let [y, m] = value.split('-').map(Number);
                m += dir;
                if (m < 1) { m = 12; y -= 1; }
                if (m > 12) { m = 1; y += 1; }
                return `${y}-${String(m).padStart(2, '0')}`;
            }
            if (type === 'quarter') {
                let [y, q] = value.split('-Q').map(Number);
                q += dir;
                if (q < 1) { q = 4; y -= 1; }
                if (q > 4) { q = 1; y += 1; }
                return `${y}-Q${q}`;
            }
            if (type === 'half') {
                let [y, h] = value.split('-H').map(Number);
                h += dir;
                if (h < 1) { h = 2; y -= 1; }
                if (h > 2) { h = 1; y += 1; }
                return `${y}-H${h}`;
            }
            if (type === 'year') {
                const y = Number(value) + dir;
                return String(y);
            }
            return value;
        }

        function refreshPeriodUI() {
            const type = document.getElementById('r_period_type').value;
            const value = document.getElementById('r_period_value').value;

            // Label
            document.getElementById('mp_label').textContent = formatPeriodLabel(type, value);

            // Disable arrows for "All time"
            const disable = (type === 'all');
            document.getElementById('mp_prev').disabled = disable;
            document.getElementById('mp_next').disabled = disable;
        }

        // Handlers (keep yours; just ensure they call refresh + rebuild)
        document.getElementById('r_period_type').addEventListener('change', () => {
            const sel = document.getElementById('r_period_type').value;
            const now = new Date();
            // set a sensible default "value" when switching types
            if (sel === 'all') {
                document.getElementById('r_period_value').value = 'all';
            } else if (sel === 'month') {
                document.getElementById('r_period_value').value =
                    `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            } else if (sel === 'quarter') {
                const q = Math.floor(now.getMonth() / 3) + 1;
                document.getElementById('r_period_value').value = `${now.getFullYear()}-Q${q}`;
            } else if (sel === 'half') {
                const h = now.getMonth() < 6 ? 1 : 2;
                document.getElementById('r_period_value').value = `${now.getFullYear()}-H${h}`;
            } else if (sel === 'year') {
                document.getElementById('r_period_value').value = String(now.getFullYear());
            }
            refreshPeriodUI();
            buildReports();
        });

        document.getElementById('mp_prev').addEventListener('click', () => {
            const type = r_period_type.value;
            const value = r_period_value.value;
            r_period_value.value = stepPeriod(type, value, -1);
            refreshPeriodUI();
            buildReports();
        });

        document.getElementById('mp_next').addEventListener('click', () => {
            const type = r_period_type.value;
            const value = r_period_value.value;
            r_period_value.value = stepPeriod(type, value, +1);
            refreshPeriodUI();
            buildReports();
        });

        // ===== Auth (very basic, front-end only) =====
        // Hardcoded creds:
        const AUTH_USER = 'admin';
        const AUTH_PASS = '817';

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appRoot').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('appRoot').style.display = 'none';
            document.getElementById('authScreen').style.display = 'grid';
        }

        function isAuthed() {
            return sessionStorage.getItem('bb_auth') === '1';
        }

        function doLogin() {
            const u = (document.getElementById('authUser').value || '').trim();
            const p = (document.getElementById('authPass').value || '').trim();
            const err = document.getElementById('authError');

            if (u === AUTH_USER && p === AUTH_PASS) {
                sessionStorage.setItem('bb_auth', '1');
                err.style.display = 'none';
                showApp();
                // kick off data load (if not already loaded)
                if (ORDERS.length === 0) {
                    (async () => { try { await loadAll(); refresh(); } catch (e) { setError('Load error: ' + e.message); } })();
                } else {
                    refresh();
                }
            } else {
                err.style.display = 'block';
            }
        }

        function doLogout() {
            sessionStorage.removeItem('bb_auth');
            showLogin();
            // Optional: clear sensitive UI state
            // location.reload(); // uncomment if you prefer a hard reset
        }

        // Wire up buttons
        document.addEventListener('DOMContentLoaded', () => {
            const $login = document.getElementById('authLogin');
            const $clear = document.getElementById('authClear');
            const $logout = document.getElementById('btnLogout');
            const $user = document.getElementById('authUser');
            const $pass = document.getElementById('authPass');

            if ($login) $login.addEventListener('click', doLogin);
            if ($clear) $clear.addEventListener('click', () => {
                document.getElementById('authUser').value = '';
                document.getElementById('authPass').value = '';
                document.getElementById('authError').style.display = 'none';
                $user?.focus();
            });
            if ($logout) $logout.addEventListener('click', doLogout);

            // Enter-to-submit
            [$user, $pass].forEach(el => {
                el?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') doLogin();
                });
            });

            // Boot: show login or app
            if (isAuthed()) {
                showApp();
                // if app loads before data, your existing IIFE will still run fetch
            } else {
                showLogin();
            }
        });


    </script>
</body>

</html>